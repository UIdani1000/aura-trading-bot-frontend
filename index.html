<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aura Trading Bot</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <aside class="sidebar">
            <div class="logo-container">
                <img src="logo.png" alt="Aura Logo" class="logo">
                <span class="app-name">Aura</span>
            </div>
            <nav class="nav-menu">
                <ul>
                    <li><a href="#" class="active"><img src="icons/dashboard-icon.png" alt="Dashboard Icon"> Dashboard</a></li>
                    <li><a href="#"><img src="icons/chat-icon.png" alt="AI Chat Icon"> AI Chat</a></li>
                    <li><a href="#"><img src="icons/analysis-icon.png" alt="Analysis Icon"> Analysis</a></li>
                    <li><a href="#"><img src="icons/alerts-icon.png" alt="Alerts Icon"> Price Alerts</a></li>
                    <li><a href="#"><img src="icons/stats-icon.png" alt="Stats Icon"> Trade Statistics</a></li>
                    <li><a href="#"><img src="icons/settings-icon.png" alt="Settings Icon"> Settings</a></li>
                </ul>
            </nav>
        </aside>
        <main class="main-content">
            <header class="header">
                <input type="text" placeholder="Search..." class="search-bar">
                <div class="user-profile">
                    <span>Daniel</span>
                    <div class="avatar"></div>
                </div>
            </header>
            <section class="dashboard-overview">
                <h1>Dashboard Overview</h1>
                <div class="market-data">
                    <div class="market-item">
                        <span>BTC Price:</span> <span id="btc-price">Loading...</span>
                    </div>
                    <div class="market-item">
                        <span>ETH Price:</span> <span id="eth-price">Loading...</span>
                    </div>
                    <div class="market-item">
                        <span>XRP Price:</span> <span id="xrp-price">Loading...</span>
                    </div>
                    <div class="market-item">
                        <span>SOL Price:</span> <span id="sol-price">Loading...</span>
                    </div>
                </div>
            </section>

            <section class="chat-section">
                <h2>AI Chat</h2>
                <div class="chat-window" id="chat-window">
                    <div class="message aura-message">
                        Hello! I am Aura, your AI Trading Assistant. How can I help you today?
                    </div>
                </div>
                <div class="chat-input-area">
                    <input type="text" id="chat-input" placeholder="Type your message or ask Aura...">
                    <button id="send-button"><img src="icons/send-icon.png" alt="Send"></button>
                </div>
            </section>

            <section class="analysis-section" style="display: none;">
                <h2>Analysis</h2>
                <button id="generate-analysis-button">Generate Market Analysis</button>
                <div id="analysis-output" class="analysis-output">
                    </div>
            </section>

            <section class="trade-log-section" style="display: none;">
                <h2>Trade Log</h2>
                <input type="text" id="trade-coin" placeholder="Coin (e.g., BTC)">
                <input type="number" id="trade-amount" placeholder="Amount">
                <select id="trade-type">
                    <option value="buy">Buy</option>
                    <option value="sell">Sell</option>
                </select>
                <button id="log-trade-button">Log Trade</button>

                <h3>Recent Trades</h3>
                <div id="trade-summary-output" class="trade-summary-output">
                    </div>

                <h3>Full Trade History</h3>
                <div id="trade-history-output" class="trade-history-output">
                    </div>
            </section>

        </main>
    </div>

    <footer>
        <p>&copy; 2023 Aura. All rights reserved.</p>
    </footer>

    <script>
        const API_BASE_URL = 'https://aura-trading-bot-backend.onrender.com'; // Your Render backend URL

        // --- Market Data Fetching ---
        async function fetchMarketPrices() {
            try {
                const response = await fetch(`${API_BASE_URL}/all_market_prices`);
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Error fetching market prices:', response.status, errorText);
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                document.getElementById('btc-price').textContent = `$${data.bitcoin.usd.toFixed(2)}`;
                document.getElementById('eth-price').textContent = `$${data.ethereum.usd.toFixed(2)}`;
                document.getElementById('xrp-price').textContent = `$${data.ripple.usd.toFixed(2)}`;
                document.getElementById('sol-price').textContent = `$${data.solana.usd.toFixed(2)}`;
            } catch (error) {
                console.error('Failed to fetch market prices:', error);
                document.getElementById('btc-price').textContent = 'Error';
                document.getElementById('eth-price').textContent = 'Error';
                document.getElementById('xrp-price').textContent = 'Error';
                document.getElementById('sol-price').textContent = 'Error';
            }
        }

        // Fetch prices immediately on load and then every 30 seconds
        fetchMarketPrices();
        setInterval(fetchMarketPrices, 30000); // Set to 30 seconds (30000 milliseconds)


        // --- AI Chat Functionality ---
        const chatInput = document.getElementById('chat-input');
        const sendButton = document.getElementById('send-button');
        const chatWindow = document.getElementById('chat-window');

        sendButton.addEventListener('click', sendMessage);
        chatInput.addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        async function sendMessage() {
            const userMessageText = chatInput.value.trim();
            if (userMessageText === '') return;

            appendMessage(userMessageText, 'user-message');
            chatInput.value = ''; // Clear input immediately

            try {
                const response = await fetch(`${API_BASE_URL}/chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ message: userMessageText })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('API Error:', errorData);
                    throw new Error(`Server responded with status ${response.status}: ${errorData.error || 'Unknown error'}`);
                }

                const data = await response.json();
                appendMessage(data.response, 'aura-message');
            } catch (error) {
                console.error('Error sending message:', error);
                appendMessage(`Error: ${error.message || 'Could not connect to Aura.'}`, 'aura-message error-message');
            }
            chatWindow.scrollTop = chatWindow.scrollHeight; // Scroll to bottom
        }

        function appendMessage(text, className) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', className);
            messageDiv.textContent = text;
            chatWindow.appendChild(messageDiv);
        }

        // --- Tab Switching Logic (for Dashboard, AI Chat, Analysis, Trade Log) ---
        document.addEventListener('DOMContentLoaded', () => {
            const navLinks = document.querySelectorAll('.nav-menu ul li a');
            const sections = {
                'Dashboard': document.querySelector('.dashboard-overview'),
                'AI Chat': document.querySelector('.chat-section'),
                'Analysis': document.querySelector('.analysis-section'),
                'Price Alerts': null, // No specific section yet, can add later
                'Trade Statistics': document.querySelector('.trade-log-section'), // Mapping to trade log for now
                'Settings': null // No specific section yet
            };

            // Hide all sections initially except Dashboard (or default)
            for (const key in sections) {
                if (sections[key] && key !== 'Dashboard') { // Default to dashboard
                    sections[key].style.display = 'none';
                }
            }

            navLinks.forEach(link => {
                link.addEventListener('click', function(event) {
                    event.preventDefault(); // Prevent default link behavior
                    const linkText = this.textContent.trim();

                    // Remove active class from all links
                    navLinks.forEach(l => l.classList.remove('active'));
                    // Add active class to clicked link
                    this.classList.add('active');

                    // Hide all sections
                    for (const key in sections) {
                        if (sections[key]) {
                            sections[key].style.display = 'none';
                        }
                    }

                    // Show the relevant section
                    if (sections[linkText]) {
                        sections[linkText].style.display = 'block';
                        // Special handling for chat window to scroll to bottom when shown
                        if (linkText === 'AI Chat') {
                            chatWindow.scrollTop = chatWindow.scrollHeight;
                        }
                    } else if (linkText === 'Price Alerts' || linkText === 'Settings') {
                        // For sections not yet implemented, you might show a message or just keep it blank
                        console.log(`${linkText} section clicked, but not implemented yet.`);
                    }
                });
            });
        });


        // --- Analysis Functionality ---
        const generateAnalysisButton = document.getElementById('generate-analysis-button');
        const analysisOutput = document.getElementById('analysis-output');

        if (generateAnalysisButton) {
            generateAnalysisButton.addEventListener('click', async () => {
                analysisOutput.textContent = 'Generating analysis, please wait...';
                try {
                    const response = await fetch(`${API_BASE_URL}/generate_analysis`);
                    if (!response.ok) {
                        const errorData = await response.json();
                        console.error('API Error:', errorData);
                        throw new Error(`Server responded with status ${response.status}: ${errorData.error || 'Unknown error'}`);
                    }
                    const data = await response.json();
                    analysisOutput.textContent = data.analysis;
                } catch (error) {
                    console.error('Error generating analysis:', error);
                    analysisOutput.textContent = `Failed to generate analysis: ${error.message || 'Network error'}`;
                }
            });
        }


        // --- Trade Logging and Summary Functionality ---
        const logTradeButton = document.getElementById('log-trade-button');
        const tradeCoinInput = document.getElementById('trade-coin');
        const tradeAmountInput = document.getElementById('trade-amount');
        const tradeTypeSelect = document.getElementById('trade-type');
        const tradeSummaryOutput = document.getElementById('trade-summary-output');
        const tradeHistoryOutput = document.getElementById('trade-history-output');

        if (logTradeButton) {
            logTradeButton.addEventListener('click', logTrade);
        }

        async function logTrade() {
            const coin = tradeCoinInput.value.trim().toUpperCase();
            const amount = parseFloat(tradeAmountInput.value);
            const type = tradeTypeSelect.value;

            if (!coin || isNaN(amount) || amount <= 0) {
                alert('Please enter a valid coin and a positive amount.');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/log_trade`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ coin, amount, type })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Failed to log trade: ${errorData.error || 'Unknown error'}`);
                }

                const data = await response.json();
                alert(data.message);
                tradeCoinInput.value = '';
                tradeAmountInput.value = '';
                fetchTradeSummary(); // Refresh summary after logging
                fetchTradeHistory(); // Refresh history after logging

            } catch (error) {
                console.error('Error logging trade:', error);
                alert(`Error: ${error.message}`);
            }
        }

        async function fetchTradeSummary() {
            try {
                const response = await fetch(`${API_BASE_URL}/get_trade_summary`);
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Failed to fetch trade summary: ${errorData.error || 'Unknown error'}`);
                }
                const data = await response.json();
                tradeSummaryOutput.innerHTML = ''; // Clear previous summary

                if (Object.keys(data).length === 0) {
                    tradeSummaryOutput.textContent = 'No trades logged yet.';
                    return;
                }

                for (const coin in data) {
                    const summaryItem = document.createElement('p');
                    summaryItem.textContent = `${coin}: Buys - ${data[coin].buy || 0}, Sells - ${data[coin].sell || 0}, Net - ${data[coin].net.toFixed(2)}`;
                    tradeSummaryOutput.appendChild(summaryItem);
                }
            } catch (error) {
                console.error('Error fetching trade summary:', error);
                tradeSummaryOutput.textContent = `Failed to load trade summary: ${error.message}`;
            }
        }

        async function fetchTradeHistory() {
            try {
                const response = await fetch(`${API_BASE_URL}/get_trades`);
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Failed to fetch trade history: ${errorData.error || 'Unknown error'}`);
                }
                const data = await response.json();
                tradeHistoryOutput.innerHTML = ''; // Clear previous history

                if (data.length === 0) {
                    tradeHistoryOutput.textContent = 'No trade history available.';
                    return;
                }

                const table = document.createElement('table');
                table.innerHTML = `
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Coin</th>
                            <th>Amount</th>
                            <th>Type</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                `;
                const tbody = table.querySelector('tbody');

                data.forEach(trade => {
                    const row = tbody.insertRow();
                    row.insertCell().textContent = new Date(trade.timestamp * 1000).toLocaleString();
                    row.insertCell().textContent = trade.coin;
                    row.insertCell().textContent = trade.amount.toFixed(2);
                    row.insertCell().textContent = trade.type;
                });
                tradeHistoryOutput.appendChild(table);

            } catch (error) {
                console.error('Error fetching trade history:', error);
                tradeHistoryOutput.textContent = `Failed to load trade history: ${error.message}`;
            }
        }


        // Initial fetch of trade summary and history when page loads (if section visible)
        // This will be called when Trade Statistics tab is clicked via DOMContentLoaded listener
    </script>
</body>
</html>